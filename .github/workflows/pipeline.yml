# Name for our workflow, shown in the "Actions" tab
name: "CI-CD - Deploy ci-cd-practice to CloudHub 2.0"

# (CHANGED) --- TRIGGERS ---
# This workflow is triggered manually from the "Actions" tab
on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment Environment"
        required: true
        type: choice
        options:
          - Sandbox
          - STAGE
          - PROD
      # (NEW) --- Added Replicas Dropdown ---
      replicas:
        description: "Number of Replicas (workers)"
        required: true
        type: choice
        default: '1'
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      # (NEW) --- Added vCores Dropdown ---
      vCores:
        description: "vCores per Replica"
        required: true
        type: choice
        default: '0.1'
        options:
          - '0.1'
          - '0.2'
          - '0.5'
          - '1'
          - '2'
      # (NEW) --- Added Release Channel Dropdown ---
      releaseChannel:
        description: "Mule Runtime Release Channel"
        required: true
        type: choice
        default: 'LTS'
        options:
          - 'LTS'
          - 'EDGE'
          - 'NONE'
      # (NEW) --- Added Mule Version Dropdown ---
      muleVersion:
        description: "Mule Runtime Version"
        required: true
        type: choice
        default: '4.9.8' # Based on your previous file
        options:
          - '4.9.8'
          - '4.7.0'
          - '4.6.0'
          # Add any other versions you target

# GLOBAL ENVIRONMENT VARIABLES
env:
  # Base app name
  APP_BASE_NAME: "ci-cd-practice"
  # (CHANGED) MULE_RUNTIME removed, as it's now an input
  # Java version for the build and deployment
  JAVA_VERSION: "17"
  # Path to your settings.xml
  MAVEN_SETTINGS_PATH: ".maven/settings.xml"

# JOBS
jobs:
  # JOB 1: Run tests
  test-application:
    runs-on: ubuntu-latest
    steps:
      # ... (This job remains unchanged) ...
      - name: "Checkout Repository"
        uses: actions/checkout@v4
      - name: "Setup Java ${{ env.JAVA_VERSION }}"
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
      - name: "Cache Maven Dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: "Run Tests"
        run: |
          mvn clean test --settings ${{ env.MAVEN_SETTINGS_PATH }}

  # JOB 2: Build and publish
  build-and-publish-to-exchange:
    needs: test-application 
    runs-on: ubuntu-latest
    steps:
      # ... (This job remains unchanged) ...
      - name: "Checkout Repository"
        uses: actions/checkout@v4
      - name: "Setup Java ${{ env.JAVA_VERSION }}"
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
      - name: "Cache Maven Dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: "Build and Publish to Exchange"
        run: |
          mvn clean deploy -DskipTests \
            --settings ${{ env.MAVEN_SETTINGS_PATH }} \
            -DconnectedAppClientId=${{ secrets.CONNECTEDAPPCLIENTID }} \
            -DconnectedAppClientSecret=${{ secrets.CONNECTEDAPPCLIENTSECRET }}

  # JOB 3: Deploy to CloudHub
  deploy-to-cloudhub:
    needs: build-and-publish-to-exchange
    runs-on: ubuntu-latest
    outputs:
      # This is still used by the email job
      DEPLOYED_APP_NAME: ${{ steps.set_vars.outputs.APP_NAME }}
      DEPLOYED_ENV: ${{ inputs.environment }}
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
      - name: "Setup Java ${{ env.JAVA_VERSION }}"
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
      - name: "Cache Maven Dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
            
      # (CHANGED) --- This script is now simpler ---
      - name: "Set Environment-Specific Configuration"
        id: set_vars 
        run: |
          # This script now ONLY sets variables that change per environment
          if [ "${{ inputs.environment }}" == "Sandbox" ]; then
            echo "TARGET_NAME=Cloudhub-US-East-2" >> $GITHUB_OUTPUT
            echo "APP_NAME=${{ env.APP_BASE_NAME }}-v1-dev" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.environment }}" == "STAGE" ]; then
            echo "TARGET_NAME=Your-STAGE-Target-Name" >> $GITHUB_OUTPUT
            echo "APP_NAME=${{ env.APP_BASE_NAME }}-v1-stage" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.environment }}" == "PROD" ]; then
            echo "TARGET_NAME=Your-PROD-Target-Name" >> $GITHUB_OUTPUT
            echo "APP_NAME=${{ env.APP_BASE_NAME }}-v1-prod" >> $GITHUB_OUTPUT
          fi

      # (CHANGED) This step now uses the new inputs from the workflow dispatch
      - name: "Deploy to CloudHub 2.0 (${{ inputs.environment }})"
        run: |
          mvn mule:deploy -DskipTests \
            --settings ${{ env.MAVEN_SETTINGS_PATH }} \
            -DconnectedAppClientId=${{ secrets.CONNECTEDAPPCLIENTID }} \
            -DconnectedAppClientSecret=${{ secrets.CONNECTEDAPPCLIENTSECRET }} \
            -Dserver=anypoint-exchange-v3 \
            -Denvironment=${{ inputs.environment }} \
            -DappName=${{ steps.set_vars.outputs.APP_NAME }} \
            -DtargetName=${{ steps.set_vars.outputs.TARGET_NAME }} \
            -DjavaVersion=${{ env.JAVA_VERSION }} \
            -DmuleVersion=${{ inputs.muleVersion }} \
            -DreleaseChannel=${{ inputs.releaseChannel }} \
            -Dreplicas=${{ inputs.replicas }} \
            -DvCores=${{ inputs.vCores }}

  # JOB 4: Send email notification
  send-notification:
    needs: deploy-to-cloudhub 
    runs-on: ubuntu-latest
    steps:
      # ... (This job remains unchanged) ...
      - name: "Send Deployment Success Email"
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: "smtp.gmail.com"
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "SUCCESS: Deployed ${{ needs.deploy-to-cloudhub.outputs.DEPLOYED_APP_NAME }} to ${{ needs.deploy-to-cloudhub.outputs.DEPLOYED_ENV }}"
          body: |
            The application **${{ needs.deploy-to-cloudhub.outputs.DEPLOYED_APP_NAME }}** was successfully deployed to the **${{ needs.deploy-to-cloudhub.outputs.DEPLOYED_ENV }}** environment.

            **Triggered by:** ${{ github.actor }}
            
            You can view the full workflow run here:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.EMAIL_RECIPIENTS }}
          from: GitHub Actions CI <${{ secrets.SMTP_USERNAME }}>
