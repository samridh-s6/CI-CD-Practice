# Name for our workflow, shown in the "Actions" tab
name: "CI-CD - Deploy ci-cd-practice to CloudHub 2.0"

on:
  # 1. Manual Trigger (same as before)
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment Environment"
        required: true
        type: choice
        options:
          - Sandbox
          - STAGE
          - PROD
      replicas:
        description: "Number of Replicas (workers)"
        required: true
        type: choice
        default: '1'
        options:
          - '1'
          - '2'
          - '3'
          - '4'
      vCores:
        description: "vCores per Replica"
        required: true
        type: choice
        default: '0.1'
        options:
          - '0.1'
          - '0.2'
          - '0.5'
          - '1'
          - '2'
      releaseChannel:
        description: "Mule Runtime Release Channel"
        required: true
        type: choice
        default: 'LTS'
        options:
          - 'LTS'
          - 'EDGE'
          - 'NONE'
      muleVersion:
        description: "Mule Runtime Version"
        required: true
        type: choice
        default: '4.9.8'
        options:
          - '4.9.8'
          - '4.7.0'
          - '4.6.0'

  # 2. Push Trigger (runs on push to the 'main' branch) ---
  push:
    branches:
      - main
      # You can add other branches like: - master

  # 3. Scheduled Trigger (runs at 5:00 AM UTC every Monday) ---
  schedule:
    - cron: '0 5 * * 1' # A "cron" string: min hour day(month) month day(week)

# GLOBAL ENVIRONMENT VARIABLES
env:
  APP_BASE_NAME: "ci-cd-practice"
  JAVA_VERSION: "17"
  MAVEN_SETTINGS_PATH: ".maven/settings.xml"

# JOBS
jobs:
  # JOB 1: Run tests
  test-application:
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
      - name: "Setup Java ${{ env.JAVA_VERSION }}"
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
      - name: "Cache Maven Dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: "Run Tests"
        run: |
          mvn clean test --settings ${{ env.MAVEN_SETTINGS_PATH }}

  # JOB 2: Build and publish
  build-and-publish-to-exchange:
    needs: test-application 
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
      - name: "Setup Java ${{ env.JAVA_VERSION }}"
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
      - name: "Cache Maven Dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: "Build and Publish to Exchange"
        run: |
          mvn clean deploy -DskipTests \
            --settings ${{ env.MAVEN_SETTINGS_PATH }} \
            -DconnectedAppClientId=${{ secrets.CONNECTEDAPPCLIENTID }} \
            -DconnectedAppClientSecret=${{ secrets.CONNECTEDAPPCLIENTSECRET }}

  # JOB 3: Deploy to CloudHub
  deploy-to-cloudhub:
    needs: build-and-publish-to-exchange
    runs-on: ubuntu-latest
    
    # (CHANGED) --- This now uses the new setup step's output ---
    outputs:
      DEPLOYED_APP_NAME: ${{ steps.set_vars.outputs.APP_NAME }}
      DEPLOYED_ENV: ${{ steps.set_exec_vars.outputs.DEPLOY_ENV }} # Changed from inputs.environment

    steps:
      - name: "Checkout Repository"
        uses: actions/checkout@v4
      - name: "Setup Java ${{ env.JAVA_VERSION }}"
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
      - name: "Cache Maven Dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
            
      # (NEW) --- This step sets variables for all triggers ---
      - name: "Set Execution Variables"
        id: set_exec_vars
        run: |
          # Check if this was a manual run
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Setting variables from MANUAL inputs..."
            echo "DEPLOY_ENV=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "REPLICAS=${{ inputs.replicas }}" >> $GITHUB_OUTPUT
            echo "VCORES=${{ inputs.vCores }}" >> $GITHUB_OUTPUT
            echo "RELEASE_CHANNEL=${{ inputs.releaseChannel }}" >> $GITHUB_OUTPUT
            echo "MULE_VERSION=${{ inputs.muleVersion }}" >> $GITHUB_OUTPUT
          else
            # Set default values for 'push' or 'schedule'
            echo "Setting variables from AUTOMATIC (push/schedule) defaults..."
            echo "DEPLOY_ENV=Sandbox" >> $GITHUB_OUTPUT
            echo "REPLICAS=1" >> $GITHUB_OUTPUT
            echo "VCORES=0.1" >> $GITHUB_OUTPUT
            echo "RELEASE_CHANNEL=LTS" >> $GITHUB_OUTPUT
            echo "MULE_VERSION=4.9.8" >> $GITHUB_OUTPUT
          fi
            
      # (CHANGED) --- This script now uses the variables from the step above ---
      - name: "Set Environment-Specific Configuration"
        id: set_vars 
        run: |
          # This script now ONLY sets variables that change per environment
          if [ "${{ steps.set_exec_vars.outputs.DEPLOY_ENV }}" == "Sandbox" ]; then
            echo "TARGET_NAME=Cloudhub-US-East-2" >> $GITHUB_OUTPUT
            echo "APP_NAME=${{ env.APP_BASE_NAME }}-v1-dev" >> $GITHUB_OUTPUT
          elif [ "${{ steps.set_exec_vars.outputs.DEPLOY_ENV }}" == "STAGE" ]; then
            echo "TARGET_NAME=Your-STAGE-Target-Name" >> $GITHUB_OUTPUT
            echo "APP_NAME=${{ env.APP_BASE_NAME }}-v1-stage" >> $GITHUB_OUTPUT
          elif [ "${{ steps.set_exec_vars.outputs.DEPLOY_ENV }}" == "PROD" ]; then
            echo "TARGET_NAME=Your-PROD-Target-Name" >> $GITHUB_OUTPUT
            echo "APP_NAME=${{ env.APP_BASE_NAME }}-v1-prod" >> $GITHUB_OUTPUT
          fi

      # (CHANGED) --- This step now uses ALL variables from the 'set_exec_vars' step ---
      - name: "Deploy to CloudHub 2.0 (${{ steps.set_exec_vars.outputs.DEPLOY_ENV }})"
        run: |
          mvn mule:deploy -DskipTests \
            --settings ${{ env.MAVEN_SETTINGS_PATH }} \
            -DconnectedAppClientId=${{ secrets.CONNECTEDAPPCLIENTID }} \
            -DconnectedAppClientSecret=${{ secrets.CONNECTEDAPPCLIENTSECRET }} \
            -Dserver=anypoint-exchange-v3 \
            -Denvironment=${{ steps.set_exec_vars.outputs.DEPLOY_ENV }} \
            -DappName=${{ steps.set_vars.outputs.APP_NAME }} \
            -DtargetName=${{ steps.set_vars.outputs.TARGET_NAME }} \
            -DjavaVersion=${{ env.JAVA_VERSION }} \
            -DmuleVersion=${{ steps.set_exec_vars.outputs.MULE_VERSION }} \
            -DreleaseChannel=${{ steps.set_exec_vars.outputs.RELEASE_CHANNEL }} \
            -Dreplicas=${{ steps.set_exec_vars.outputs.REPLICAS }} \
            -DvCores=${{ steps.set_exec_vars.outputs.VCORES }}

  # JOB 4: Send email notification
  send-notification:
    # This job now works with all trigger types
    needs: deploy-to-cloudhub 
    runs-on: ubuntu-latest
    steps:
      - name: "Send Deployment Success Email"
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: "smtp.gmail.com"
          server_port: 465
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          # This subject now correctly uses the output from the deploy job
          subject: "SUCCESS: Deployed ${{ needs.deploy-to-cloudhub.outputs.DEPLOYED_APP_NAME }} to ${{ needs.deploy-to-cloudhub.outputs.DEPLOYED_ENV }}"
          body: |
            The application **${{ needs.deploy-to-cloudhub.outputs.DEPLOYED_APP_NAME }}** was successfully deployed to the **${{ needs.deploy-to-cloudhub.outputs.DEPLOYED_ENV }}** environment.

            **Triggered by:** ${{ github.actor }} (Event: ${{ github.event_name }})
            
            You can view the full workflow run here:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: ${{ secrets.EMAIL_RECIPIENTS }}
          from: GitHub Actions CI <${{ secrets.SMTP_USERNAME }}>
